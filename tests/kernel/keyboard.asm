%INCLUDE "kb_map.asm"

KB_INIT:
    MOV64 G0, 10
    MOV64 G1, KEY_PRESSED
    CALL IVT_INSTALL

KEY_PRESSED:
    MOV32 G3, [0x12000]
    CMP32 G3, 340
    JE KEY_SHIFT
    MOV8 G4, [0x12004]
    CMP8 G4, 1
    JE KEY_DOWN
    JMP KEY_EXIT
KEY_DOWN:
    CMP32 G3, 257 ; ENTER
    JE KEY_ENTER
    CMP32 G3, 259
    JE KEY_BACKSPACE
    MOV32 G1, [CURSOR_X]
    MOV32 G2, [CURSOR_Y]
    MOV8 G3, [0x12000]
    CMP8 [SHIFT], 1
    JE KEY_DOWN_S
    MOV8 G3, [KB_MAP_NS+G3]
    JMP KEY_DOWN_C
KEY_DOWN_S:
    MOV8 G3, [KB_MAP_S+G3]
KEY_DOWN_C:
    MOV8 G4, 0x02
    CALL PUT_CHAR
    MOV64 G4, [KB_BUFFER_IDX]
    MOV8 [KB_BUFFER+G4], G3
    ADD64 [KB_BUFFER_IDX], 1
    ADD32 [CURSOR_X], 1
    CALL UPDATE_CURSOR
    JMP KEY_EXIT
KEY_SHIFT:
    MOV8 G4, [0x12004] ; STATUS
    CMP8 G4, 1 ; DOWN
    JE KEY_APPLY_SHIFT
    MOV8 [SHIFT], 0
    JMP KEY_EXIT
KEY_APPLY_SHIFT:
    MOV8 [SHIFT], 1
    JMP KEY_EXIT
KEY_BACKSPACE:
    CMP64 [KB_BUFFER_IDX], 0
    JE KEY_EXIT
    SUB32 [CURSOR_X], 1
    CALL UPDATE_CURSOR
    SUB64 [KB_BUFFER_IDX], 1
    MOV64 G4, [KB_BUFFER_IDX]
    MOV8 [KB_BUFFER+G4], 0
    MOV32 G1, [CURSOR_X]
    MOV32 G2, [CURSOR_Y]
    MOV8 G3, 0
    CALL PUT_CHAR
    JMP KEY_EXIT
KEY_ENTER:
    MOV32 [CURSOR_X], 0
    ADD32 [CURSOR_Y], 1
    CALL UPDATE_CURSOR
    MOV64 G4, [KB_BUFFER_IDX]
    MOV8 [KB_BUFFER+G4], 0
    MOV64 [KB_BUFFER_IDX], 0
    CALL KB_ENTER
KEY_EXIT:
    MOV8 [0x13000], 0
    RET

KB_BUFFER_IDX: D64 0
KB_BUFFER: RES8 512
SHIFT: D8 0